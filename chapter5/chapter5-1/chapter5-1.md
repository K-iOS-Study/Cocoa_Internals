# 불변객체와 가변객체

코코아 프레임워크 객체는 크게 2가지로 분류할 수 있다.
1. 초기화한 이후에는 내부 데이터를 변경할 수 없는 불변 객체
	- 문자열을 다루는 NSString 클래스는 문자열을 바꿀 수 있는 인터페이스가 없는 불변 객체다.
2. 반대로, 초기화한 이후에도 내부 데이터를 변경할 수 있는 가변 객체


## 불변 객체

Immutable 객체들은 다음과 같은 특징을 갖는다.

- 초기화 이후 객체 내부의 값이나 상태가 변하지 않는다.
- 불변 속성 때문에 여러 객체에서, 여러 스레드에서 참조해도 안전하다.
	- 멀티 스레드 환경에서 같은 객체에 접근하여도 값/상태가 변경되지 않아, Concurrency 문제가 야기되지 않음
- 값이 바뀌는 상황을 고민하지 않기 때문에, 설계가 쉽고 구현하기 수월하다.
- 객체 내부에 모순된 상태가 줄어들어 부작용이 적다.


이런 불변 객체의 특징 때문에 FP에서는 불변 객체를 더 많이 쓴다.
심지어 불변 객체만 사용하라고 권장한다.
불변 객체의 사용은 **의도하지 않은 부작용** 의 가능성을 낮춘다.

불변 객체만을 사용하는 방식으로 구현하면 객체들 사이의 참조 관계가 비교적 단순해진다.
**하지만 값이 다르면 새로운 객체를 만들어야한다는 단점이 있다.**

**불변 객체 인스턴스 개수가 많아지는 경우를 대비해 메모리를 효율적으로 사용하기 위한 최적화 과정**을 두기도 한다.
불변 객체 중에 **'정체성'** 이 동일한 객체가 이미 존재하는지 확인하고, 중복된 불변 객체를 만들지 않도록 최적화한다.
특히, NSString 클래스 리터럴 문자열은 불변 객체로, 프로세스 메모리 영역에 문자열을 할당해서 중복 생성을 줄인다.


### 불변 객체 클래스

불변 객체는 초기화 메서드로 객체의 초기값을 지정한 이후에는 객체 상태를 변경할 수 있는 메서드를 제공하지 않는다.
대부분 객체 내부의 인스턴스 변수는 감춰지거나(private) 보이더라도 읽기만 가능하다.

코코아 프레임워크에 불변 객체 클래스가 많지만, 자주 사용하는 클래스는 다음과 같다.

- 타입별 데이터 구조를 다루는 클래스 : NSNumber, NSValue, NSData
- 규격에 맞춰 데이터를 다루는 클래스 : NSString, NSDate, NSURL
- 다른 객체를 참조하는 클래스 : NSArray, NSDictionary
- 다른 객체를 꾸며주는 클래스 : NSFont, NSColor


이 클래스 중 일부는 동일한 역할을 하면서 데이터를 변경할 수 있는 동등한 수준의 가변 객체 클래스(NSMutableString 등)가 존재하기도 한다.
반면에 가변 객체 없이 값만 저장하는 클래스도 있다.

Ex) NSString이나 NSData는 NSMutableString, NSMutableData가 있지만, NSNumber나 NSColors는 가변 객체 클래스가 없다.
만약 가변 객체 클래스가 존재한다면, 객체를 복사할 때 -> -mutableCopy로 가변 객체를 복사할 수 있는지도 확인해야 한다.


### 불변 객체 구현하기

고려해야 할 사항

- **초기화 이후 내부 값이나 상태를 재정의하는 메서드가 없어**야한다.
- **내부 전용 인스턴스 변수는 감추고 접근**하지 못하도록 한다.
- 인스턴스 변수들은 상속이 불가능하도록 private 속성을 갖도록 하고, 읽기 전용 접근자만 허용한다.
- 내부 데이터를 바꾸는 게 아니라 **새로운 값을 반환하도록 구현**한다.
- 내부에서만 사용하는 가변 객체가 있다면, 외부에서 내부 가변 객체를 반환하거나 수정할 수 있는 인터페이스가 없어야 한다.

하지만 다음의 경우라면 불변 객체보다는 다른 방법을 고민해봐라.
다른 방법 : **가변 객체로 설계를 바꾸고 변동 가능성을 낮추며 구현하라**

1. 내부 데이터가 **너무 커서 복사하기 부담**스러운 경우
	- 복사하여서 새로운 값을 반환해야 하기 때문
2. 초기 생성자에서 **모든 값을 정할 수 없고, lazy 혹은 점진적으로 데이터를 정해**야 하는 경우
3. 클래스 내부에 구조체를 포함하고, 그 **구조체 내부에 변경가능한 하위 요소**가 있는 경우
4. 상태를 공유하는 **공용 컨테이너**로 동작하는 경우

### 요약

불변 객체 클래스를 직접 만들거나 코코아 프레임워크에 있는 불변 객체를 사용하면 참조 관계가 단순해져서 복잡도를 낮출 수 있다.
굳이 가변 객체를 사용할 이유가 없다면, 불변 객체를 사용하자.
부작용이 발생할 수 있는 위험을 줄일 수 있다.
최근에는 블록을 활용한 핸들러 코드나 비동기 프로그래밍 방식에서도 불변 객체가 안전하다.
다중 스레드상에서도 동시에 접근해도 훨씬 안전하다.
